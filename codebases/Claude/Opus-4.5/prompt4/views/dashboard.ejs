<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BlueMind Security Demo</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="logo">
                <i class="fas fa-brain"></i>
                <span>BlueMind Dashboard</span>
            </div>
            <div class="user-info">
                <span><i class="fas fa-user"></i> <%= user.email %></span>
                <form method="POST" action="/logout" style="display: inline;">
                    <button type="submit" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
        </header>
        
        <main class="dashboard-main">
            <div class="sidebar">
                <nav class="dashboard-nav">
                    <ul>
                        <li class="active">
                            <a href="#messages">
                                <i class="fas fa-envelope"></i>
                                Messages
                                <span class="message-count" id="messageCount"><%= messages.length %></span>
                            </a>
                        </li>
                        <li>
                            <a href="#compose">
                                <i class="fas fa-edit"></i>
                                Compose
                            </a>
                        </li>
                        <li>
                            <a href="/security-logs">
                                <i class="fas fa-shield-alt"></i>
                                Security Logs
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            
            <div class="content">
                <div class="content-section active" id="messages">
                    <div class="section-header">
                        <h2><i class="fas fa-inbox"></i> Inbox</h2>
                        <div class="message-stats">
                            <span>Total: <%= messages.length %> messages</span>
                            <button class="refresh-btn" onclick="refreshMessages()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="messages-container">
                        <% if (messages.length === 0) { %>
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h3>No messages yet</h3>
                                <p>Start a conversation by composing a new message!</p>
                            </div>
                        <% } else { %>
                            <div class="messages-list">
                                <% messages.forEach(message => { %>
                                    <div class="message-item <%= message.read_at ? 'read' : 'unread' %>" data-message-id="<%= message.id %>">
                                        <div class="message-header">
                                            <div class="sender">
                                                <i class="fas fa-user-circle"></i>
                                                <strong><%= message.sender_email %></strong>
                                            </div>
                                            <div class="timestamp">
                                                <i class="fas fa-clock"></i>
                                                <%= new Date(message.sent_at).toLocaleDateString() %>
                                                <%= new Date(message.sent_at).toLocaleTimeString() %>
                                            </div>
                                        </div>
                                        <div class="message-subject">
                                            <strong><%= message.subject %></strong>
                                        </div>
                                        <div class="message-preview">
                                            <%= message.content.substring(0, 100) %>
                                            <% if (message.content.length > 100) { %>...
                                            <% } %>
                                        </div>
                                        <div class="message-actions">
                                            <button onclick="viewMessage('<%= message.id %>')" class="btn-view">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <% if (!message.read_at) { %>
                                                <button onclick="markAsRead('<%= message.id %>')" class="btn-mark-read">
                                                    <i class="fas fa-check"></i> Mark Read
                                                </button>
                                            <% } %>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div class="content-section" id="compose">
                    <div class="section-header">
                        <h2><i class="fas fa-edit"></i> Compose Message</h2>
                    </div>
                    
                    <form id="composeForm" class="compose-form">
                        <div class="form-group">
                            <label for="recipient">
                                <i class="fas fa-user"></i>
                                Recipient
                            </label>
                            <select id="recipient" name="recipientId" required>
                                <option value="">Select a user...</option>
                                <% users.forEach(user => { %>
                                    <option value="<%= user.id %>"><%= user.email %></option>
                                <% }); %>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="subject">
                                <i class="fas fa-tag"></i>
                                Subject
                            </label>
                            <input type="text" id="subject" name="subject" placeholder="Enter subject...">
                        </div>
                        
                        <div class="form-group">
                            <label for="content">
                                <i class="fas fa-comment"></i>
                                Message
                            </label>
                            <textarea id="content" name="content" rows="8" placeholder="Type your message here..." required></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="send-btn">
                                <i class="fas fa-paper-plane"></i>
                                Send Message
                            </button>
                            <button type="button" onclick="clearForm()" class="clear-btn">
                                <i class="fas fa-trash"></i>
                                Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalSubject"></h3>
                <button class="close-modal" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="message-meta">
                    <div><strong>From:</strong> <span id="modalSender"></span></div>
                    <div><strong>Date:</strong> <span id="modalDate"></span></div>
                </div>
                <div class="message-content" id="modalContent"></div>
            </div>
        </div>
    </div>
    
    <script>
        const socket = io();
        const currentUserId = <%= userId %>;
        
        // Join user's room for real-time notifications
        socket.emit('join_room', currentUserId);
        
        // Listen for new messages
        socket.on('new_message', (data) => {
            if (data.recipientId === currentUserId) {
                showNotification('New message received!');
                refreshMessages();
            }
        });
        
        // Navigation
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.dashboard-nav a');
            const contentSections = document.querySelectorAll('.content-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    
                    // Update navigation
                    document.querySelector('.dashboard-nav .active').classList.remove('active');
                    this.parentElement.classList.add('active');
                    
                    // Update content
                    document.querySelector('.content-section.active').classList.remove('active');
                    document.getElementById(targetId).classList.add('active');
                });
            });
        });
        
        // Message functions
        function refreshMessages() {
            location.reload(); // Simple refresh for demo
        }
        
        function viewMessage(messageId) {
            // Get message data (simplified - in production would fetch from API)
            const messageItem = document.querySelector(`[data-message-id="${messageId}"]`);
            const sender = messageItem.querySelector('.sender strong').textContent;
            const subject = messageItem.querySelector('.message-subject strong').textContent;
            const timestamp = messageItem.querySelector('.timestamp').textContent.replace('ðŸ•’', '').trim();
            
            // For demo, we'll show the preview content. In production, fetch full content
            const content = messageItem.querySelector('.message-preview').textContent;
            
            document.getElementById('modalSubject').textContent = subject;
            document.getElementById('modalSender').textContent = sender;
            document.getElementById('modalDate').textContent = timestamp;
            document.getElementById('modalContent').textContent = content;
            
            document.getElementById('messageModal').style.display = 'block';
            
            // Mark as read
            markAsRead(messageId);
        }
        
        function markAsRead(messageId) {
            fetch(`/api/messages/${messageId}/read`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageItem = document.querySelector(`[data-message-id="${messageId}"]`);
                    messageItem.classList.remove('unread');
                    messageItem.classList.add('read');
                    
                    const markReadBtn = messageItem.querySelector('.btn-mark-read');
                    if (markReadBtn) {
                        markReadBtn.remove();
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }
        
        function clearForm() {
            document.getElementById('composeForm').reset();
        }
        
        function showNotification(message) {
            // Simple notification - in production use a proper notification library
            alert(message);
        }
        
        // Compose form submission
        document.getElementById('composeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Message sent successfully!');
                    clearForm();
                } else {
                    alert('Error sending message: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending message');
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    </script>
</body>
</html>