<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueMind Security Demo - Compose Message</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1 class="dashboard-title">
                    <a href="/dashboard" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 12px;">
                        <div class="logo-icon" style="width: 32px; height: 32px;">
                            <div style="width: 16px; height: 16px; border: 2px solid white; border-radius: 50%; border-top-color: transparent; border-right-color: transparent;"></div>
                        </div>
                        BlueMind - Compose Message
                    </a>
                </h1>
            </div>
            <div class="user-info">
                <a href="/dashboard" style="color: rgba(255,255,255,0.8); text-decoration: none; margin-right: 16px;">‚Üê Back to Dashboard</a>
                <form method="POST" action="/logout" style="display: inline;">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>

        <!-- Compose Form -->
        <div class="dashboard-content">
            <div style="max-width: 800px; margin: 0 auto;">
                <!-- Alert Messages -->
                <% if (error) { %>
                    <div class="alert alert-error" style="margin-bottom: 24px;">
                        <%= error %>
                    </div>
                <% } %>
                
                <% if (message) { %>
                    <div class="alert alert-success" style="margin-bottom: 24px;">
                        <%= message %>
                    </div>
                <% } %>

                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 32px;">
                    <h2 style="margin: 0 0 24px 0; color: #1f2937;">New Message</h2>

                    <form method="POST" action="/compose">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                        
                        <!-- Recipient Selection -->
                        <div class="form-group">
                            <label for="recipient_id" class="form-label">
                                <svg class="form-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                To
                            </label>
                            <select id="recipient_id" name="recipient_id" class="form-input" required>
                                <option value="">Select recipient...</option>
                                <% users.forEach(function(user) { %>
                                    <option value="<%= user.id %>"><%= user.email %></option>
                                <% }); %>
                            </select>
                        </div>

                        <!-- Subject -->
                        <div class="form-group">
                            <label for="subject" class="form-label">
                                <svg class="form-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 011 1v1a1 1 0 01-1 1h-1v10a2 2 0 01-2 2H6a2 2 0 01-2-2V7H3a1 1 0 01-1-1V5a1 1 0 011-1h4z"></path>
                                </svg>
                                Subject
                            </label>
                            <input 
                                type="text" 
                                id="subject" 
                                name="subject" 
                                class="form-input" 
                                placeholder="Enter message subject"
                                maxlength="200"
                                required 
                            />
                            <small style="color: #6b7280; font-size: 12px;">Maximum 200 characters</small>
                        </div>

                        <!-- Message Body -->
                        <div class="form-group">
                            <label for="body" class="form-label">
                                <svg class="form-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Message
                            </label>
                            <textarea 
                                id="body" 
                                name="body" 
                                class="form-input" 
                                style="min-height: 200px; resize: vertical;"
                                placeholder="Type your message here..."
                                maxlength="5000"
                                required
                            ></textarea>
                            <small style="color: #6b7280; font-size: 12px;">
                                <span id="charCount">0</span>/5000 characters. 
                                Basic HTML tags allowed: &lt;b&gt;, &lt;i&gt;, &lt;em&gt;, &lt;strong&gt;, &lt;p&gt;, &lt;br&gt;
                            </small>
                        </div>

                        <!-- Security Notice -->
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 12px; margin-bottom: 24px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: #1d4ed8; font-size: 14px;">
                                <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                                <strong>Security Note:</strong> All messages are sanitized to prevent XSS attacks. HTML content is filtered for safety.
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <a href="/dashboard" class="btn-secondary" style="background: #6b7280; color: white; text-decoration: none; padding: 12px 24px; border-radius: 6px; font-weight: 500;">
                                Cancel
                            </a>
                            <button type="submit" class="btn-primary" style="padding: 12px 24px;">
                                Send Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Character counter
        const bodyTextarea = document.getElementById('body');
        const charCount = document.getElementById('charCount');

        bodyTextarea.addEventListener('input', function() {
            charCount.textContent = this.value.length;
            
            if (this.value.length > 4500) {
                charCount.style.color = '#dc2626';
            } else if (this.value.length > 4000) {
                charCount.style.color = '#d97706';
            } else {
                charCount.style.color = '#6b7280';
            }
        });

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const recipient = document.getElementById('recipient_id').value;
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('body').value.trim();

            if (!recipient) {
                alert('Please select a recipient.');
                e.preventDefault();
                return;
            }

            if (!subject) {
                alert('Please enter a subject.');
                e.preventDefault();
                return;
            }

            if (!body) {
                alert('Please enter a message.');
                e.preventDefault();
                return;
            }

            if (body.length > 5000) {
                alert('Message is too long (maximum 5000 characters).');
                e.preventDefault();
                return;
            }
        });
    </script>
</body>
</html>