<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose Message</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="messages-page">
    <div class="app-container">
        <!-- Navigation Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>SecureMsg</h1>
                <p class="user-info">Welcome, <strong><%= userName %></strong></p>
            </div>

            <ul class="nav-menu">
                <li><a href="/messages" class="nav-item">üìÆ Inbox</a></li>
                <li><a href="/messages/sent" class="nav-item">üì§ Sent</a></li>
                <li><a href="/messages/compose" class="nav-item active">‚úèÔ∏è Compose</a></li>
            </ul>

            <div class="sidebar-footer">
                <a href="/logout" class="btn btn-logout">Logout</a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="content-header">
                <h2>Compose New Message</h2>
            </div>

            <div class="compose-form-container">
                <form id="composeForm" class="compose-form">
                    <div class="form-group">
                        <label for="recipientId">To:</label>
                        <select id="recipientId" name="recipientId" required>
                            <option value="">-- Select Recipient --</option>
                            <% recipients.forEach(user => { %>
                                <option value="<%= user.id %>">
                                    <%= user.full_name %> (<%= user.email %>)
                                </option>
                            <% }); %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="subject">Subject:</label>
                        <input 
                            type="text" 
                            id="subject" 
                            name="subject"
                            placeholder="Message subject (optional)"
                            maxlength="200"
                        >
                    </div>

                    <div class="form-group">
                        <label for="body">Message:</label>
                        <textarea 
                            id="body" 
                            name="body"
                            placeholder="Type your message here..."
                            required
                            rows="10"
                        ></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Send Message</button>
                        <a href="/messages" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        document.getElementById('composeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                recipientId: document.getElementById('recipientId').value,
                subject: document.getElementById('subject').value,
                body: document.getElementById('body').value
            };

            try {
                const response = await fetch('/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Message sent successfully!');
                    window.location.href = '/messages/sent';
                } else {
                    alert('Error sending message: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
    </script>
</body>
</html>
